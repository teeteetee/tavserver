doctype html
html(lang='en')
head
    meta(charset='utf-8')
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    meta(name='viewport', content='width=device-width, initial-scale=1')
    title Anonymity Standards
    //
       Bootstrap 
    link(href='/bootstrap/css/bootstrap.min.css', rel='stylesheet')
    //
       HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries 
    //
       WARNING: Respond.js doesn't work if you view the page via file:// 
    //if lt IE 9
      script(src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js')
      script(src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js')
    style
     :css
      h1 {
      font-family:tahoma;
      font-weight:bold;
      letter-spacing:1vw;
      }
      #header {
      border-bottom:1px solid #ddd ;
      text-align:center;
      }
      img {
      width:100%;
      }
      #textblock {
      padding-top:2vw;
      }
      h5 {
      padding-top:15%;
      font-size:3vw;
      color:#c35204;
      }
      #menu {
      text-align:center;
      border-bottom:1px solid #ddd;
      }
      h2 {
      font-size:1vw;
      font-family:tahoma;
      display:inline;
      color:gray;
      }
      .rb {
      border-right:1px solid #ddd;
      }
      #chat:hover{
      background:#D7E7FF;
      }
      #guides:hover{
      background:#D7E7FF;
      }
      #annc {
      padding-top:2vw;
      color:gray;
      }
      #chatwindow {
      border:1px solid gray;
      }
      button {
      border-radius:0px;
      border:1px solid gray;
      background-color:white;
      color:#c35;
      }
      #buttons {
      padding-top:1vw;
      }
      #inputfield {
      height:30px;
      }
      .form-control {
      border-radius:0px;
      }
      .mmessage {
      text-align:left;
      background-color:#CBFFCC;
      margin:0px;
      padding:0px;
      }
      .ymessage {
      text-align:right;
      background-color:#D6FFF9;
      margin:0px;
      padding:0px;
      }
      .emessage {
      text-align:center;
      background-color:#FFCBEE;
      color:#c35;
      margin:0px;
      padding:0px;
      }
  body
    script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js')   
    script(src='/js/bootstrap.min.js') 
    .container
      #header.row
        .col-xs-12
          h1  ANONYMITY STANDARDS
      #menu.row
        #chat.col-xs-6.rb
          h2 CHAT
        #guides.col-xs-6
          h2 GUIDES
      #textblock.row
        .col-xs-6
          label ENTER OPPONENT'S ADRESS NUMBER:
          input#oppnum(type='text', name='oppnum')
        .col-xs-2
          button.form-control(type='button',id='oppconf',style='background-color:#D4FFD4;color:#44A84E;') Confirm 
        .col-xs-4
          label YOUR ADRESS NUMBER: #{adress}
      #annc.row
        .col-xs-12
          p
            | Your messsages exist while you communicate: after you close browser window, db on server gets emptied
      #chatwindow.row
        .col-xs-12( style='height: 250px;')
      #buttons.row
        #inputfield.col-xs-8(style='padding-left: 0px; padding-right: 0px;')
          input#userinput.form-control(name='userinput',disabled)
        .col-xs-2
          button.form-control(type='button', id='send', style='background-color: #ddd;',disabled) Send
        .col-xs-2
          button.form-control(type='button', id='drop', style='background-color: #c35;',disabled) Drop
      
      script.
        var sent = 0;
        var recieved = 0;
        $('#oppconf').click(function(){
        var v = $('#oppnum').val();
        var y = $('#oppnum').val().length; 
        if (y = 7 && /^(\d|,)+$/.test(v) === true)
        {$( "#send" ).prop( "disabled", false );
        $( "#drop" ).prop( "disabled", false );
        $( "#userinput" ).prop( "disabled", false );
         setInterval(function(){ var y = $('#oppnum').val().length; if (y = 7) {check()}},5000);
         }
        });
        $('#send').click(function(){send();});
        $('#drop').click(function(){drop();});
        function drop() {
        var xhr = new XMLHttpRequest();
        var url = '/chat/drop';
        xhr.open("get",url,true);
        xhr.send(null)
        xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
        if (200<xhr.status<304) {
        $('#chatwindow').append("<div class='row ymessage'><div class='col-xs-12'>"+xhr.responseText+"</div></div>");
        }
        }
        }
        }
        function check() {
        var xhr = new XMLHttpRequest();
        var url = '/chat/check/'+$('#oppnum').val;
        xhr.open("get",url,true);
        xhr.send(null)
        xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
        if (200<xhr.status<304) {
        if (xhr.responseText != undefined && xhr.status == 200) {
        var response = JSON.parse(xhr.responseText);
        $('#chatwindow').append("<div class='row ymessage'><div class='col-xs-12'>"+response.message+"</div></div>");
        recieved = response.sent;
        }
        else {
        }
        }
        }
        }
        }
        function send() {
        var xhr = new XMLHttpRequest();
        var url = '/chat';
        var data = $('#userinput').val();
        var opp = $('#oppnum').val();
        sent++;
        var message = 'recieved='+recieved+'&sent='+sent+'&oppid='+opp+'&id=#{adress}&message='+encodeURIComponent(data);
        xhr.open("post",url,true);
        xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        $('#chatwindow').append("<div class='row mmessage'><div class='col-xs-12'>"+data+"</div></div>");
        xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
        if (xhr.status != 200) {
        // обработать ошибку
        $('#chatwindow').append("<div class='row emessage'><div class='col-xs-12'>Error"+xhr.status+xhr.statusText+"</div></div>");
        return;
        }
        // обработать результат
         if (xhr.responseText != undefined && xhr.status == 200 ) {
        var response = JSON.parse(xhr.responseText);
        recieved = response.sent;
        $('#chatwindow').append("<div class='row ymessage'><div class='col-xs-12'>"+response.message+"</div></div>");

        }
        else {

        }
        }
        }
        xhr.send(message);
        }
    